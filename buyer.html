<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PetalRush Buyer</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;margin:0;padding:0;}

body{
  background:#0d0f14;
  color:#f0ede8;
  font-family:'DM Sans',sans-serif;
  min-height:100vh;
}

.container{
  max-width:500px;
  margin:auto;
  padding-bottom:85px;
  position:relative;
}

/* HEADER */
.header{
  background:linear-gradient(135deg,#1a0a0f 0%,#0d0f14 100%);
  padding:14px 20px;
  text-align:center;
  border-bottom:1px solid rgba(255,80,100,0.15);
  position:sticky;
  top:0;
  z-index:100;
  backdrop-filter:blur(10px);
}

.header-logo{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}

.header-logo-icon{
  width:38px;height:38px;
  background:linear-gradient(135deg,#ff4081,#ff6b6b);
  border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;
  box-shadow:0 4px 15px rgba(255,64,129,0.4);
}

.header-logo-text{
  font-family:'Playfair Display',serif;
  font-size:22px;
  font-weight:700;
  background:linear-gradient(135deg,#ff4081,#ffb3c6);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  letter-spacing:0.5px;
}

.header-logo-sub{
  font-size:10px;
  color:#888;
  letter-spacing:2px;
  text-transform:uppercase;
  margin-top:-2px;
}

/* FILTER BAR */
.filter-bar{
  padding:12px 14px;
  background:#111318;
  display:flex;
  gap:10px;
  border-bottom:1px solid rgba(255,255,255,0.04);
}

input,select{
  flex:1;
  padding:11px 14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.08);
  background:#1a1d26;
  color:#f0ede8;
  font-family:'DM Sans',sans-serif;
  font-size:14px;
  outline:none;
  transition:border 0.2s;
}

input:focus,select:focus{
  border-color:rgba(255,64,129,0.4);
}

input::placeholder{color:#555;}

select option{background:#1a1d26;}

/* PRODUCTS GRID */
#home{
  display:none;
  padding:14px;
  gap:12px;
  grid-template-columns:repeat(auto-fill,minmax(145px,1fr));
}

.card{
  background:#13161f;
  border-radius:14px;
  overflow:hidden;
  cursor:pointer;
  border:1px solid rgba(255,255,255,0.05);
  transition:transform 0.2s,box-shadow 0.2s,border-color 0.2s;
}

.card:hover{
  transform:translateY(-3px);
  box-shadow:0 10px 30px rgba(255,64,129,0.15);
  border-color:rgba(255,64,129,0.2);
}

.card img{
  width:100%;
  height:130px;
  object-fit:cover;
  display:block;
  background:#1a1d26;
}

.card-body{
  padding:10px;
}

.card-name{
  font-size:13px;
  font-weight:500;
  color:#e0ddd8;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  margin-bottom:4px;
}

.card-price{
  font-size:14px;
  font-weight:600;
  color:#ff4081;
}

/* SECTIONS */
.section{display:none;padding:14px;}

.section h2{
  font-family:'Playfair Display',serif;
  font-size:22px;
  margin-bottom:16px;
  color:#f0ede8;
}

.section h3{
  font-size:15px;
  font-weight:600;
  margin:20px 0 10px;
  color:#ccc;
}

/* BUTTONS */
.btn{
  background:linear-gradient(135deg,#ff4081,#e0205f);
  border:none;
  padding:13px;
  width:100%;
  border-radius:10px;
  color:white;
  margin-top:10px;
  cursor:pointer;
  font-family:'DM Sans',sans-serif;
  font-size:15px;
  font-weight:500;
  letter-spacing:0.3px;
  transition:opacity 0.2s,transform 0.1s;
  box-shadow:0 4px 15px rgba(255,64,129,0.25);
}

.btn:hover{opacity:0.9;transform:translateY(-1px);}
.btn:active{transform:translateY(0);}

.btn-secondary{
  background:#1a1d26;
  border:1px solid rgba(255,255,255,0.1);
  box-shadow:none;
}

.btn-secondary:hover{border-color:rgba(255,64,129,0.3);opacity:1;}

/* DETAIL */
#detail .product-image{
  width:100%;
  border-radius:14px;
  object-fit:cover;
  max-height:280px;
  background:#1a1d26;
}

#detail .product-name{
  font-family:'Playfair Display',serif;
  font-size:22px;
  margin:14px 0 6px;
}

#detail .product-price{
  font-size:20px;
  font-weight:600;
  color:#ff4081;
  margin-bottom:6px;
}

#detail .product-desc{
  font-size:14px;
  color:#888;
  line-height:1.6;
  margin-bottom:14px;
}

/* CART */
.cart-item{
  background:#13161f;
  padding:14px;
  margin-top:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.05);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.cart-item-info{
  flex:1;
}

.cart-item-name{
  font-size:14px;
  font-weight:500;
  color:#e0ddd8;
  margin-bottom:4px;
}

.cart-item-qty{
  font-size:12px;
  color:#888;
}

.cart-item-price{
  font-size:15px;
  font-weight:600;
  color:#ff4081;
  margin-right:10px;
}

.delete-btn{
  background:rgba(255,64,81,0.1);
  border:1px solid rgba(255,64,81,0.2);
  color:#ff4081;
  padding:6px 12px;
  border-radius:8px;
  cursor:pointer;
  font-size:12px;
  transition:background 0.2s;
}

.delete-btn:hover{background:rgba(255,64,81,0.2);}

/* INVOICE */
.invoice{
  background:#13161f;
  padding:16px;
  margin-top:14px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.06);
  font-size:14px;
  line-height:2;
}

.invoice hr{
  border:none;
  border-top:1px solid rgba(255,255,255,0.06);
  margin:8px 0;
}

.invoice-row{
  display:flex;
  justify-content:space-between;
}

.invoice-total{
  display:flex;
  justify-content:space-between;
  font-size:16px;
  font-weight:700;
  color:#f0ede8;
}

/* BOTTOM NAV */
.bottom{
  position:fixed;
  bottom:0;
  width:100%;
  max-width:500px;
  display:flex;
  background:#111318;
  border-top:1px solid rgba(255,255,255,0.06);
  z-index:100;
}

.bottom-tab{
  flex:1;
  text-align:center;
  padding:14px 0 12px;
  cursor:pointer;
  font-size:12px;
  color:#666;
  transition:color 0.2s;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
}

.bottom-tab.active{color:#ff4081;}

.bottom-tab svg{
  width:22px;height:22px;
}

/* AVATAR */
.avatar-wrap{
  display:flex;
  justify-content:center;
  margin-bottom:20px;
  position:relative;
  width:fit-content;
  margin-left:auto;
  margin-right:auto;
}

.avatar{
  width:110px;height:110px;
  border-radius:50%;
  border:3px solid #ff4081;
  object-fit:cover;
  cursor:pointer;
  background:#1a1d26;
  display:block;
  transition:opacity 0.2s;
}

.avatar:hover{opacity:0.85;}

.avatar-edit{
  position:absolute;
  bottom:4px;
  right:0px;
  background:#ff4081;
  border-radius:50%;
  width:28px;height:28px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  box-shadow:0 2px 8px rgba(0,0,0,0.4);
  font-size:13px;
}

/* ORDER CARD */
.order-card{
  background:#13161f;
  border:1px solid rgba(255,255,255,0.05);
  border-radius:12px;
  padding:14px;
  margin-top:10px;
}

.order-id{
  font-size:12px;
  color:#888;
  margin-bottom:6px;
}

.order-total{
  font-size:16px;
  font-weight:700;
  color:#ff4081;
  margin-bottom:10px;
}

.order-item-line{
  font-size:13px;
  color:#aaa;
  padding:3px 0;
  border-bottom:1px solid rgba(255,255,255,0.04);
}

/* EMPTY STATE */
.empty-state{
  text-align:center;
  padding:40px 20px;
  color:#555;
}

.empty-state div{font-size:40px;margin-bottom:10px;}

/* TOAST */
.toast{
  position:fixed;
  bottom:90px;
  left:50%;
  transform:translateX(-50%) translateY(20px);
  background:#1e2130;
  border:1px solid rgba(255,64,129,0.3);
  color:#f0ede8;
  padding:12px 22px;
  border-radius:25px;
  font-size:14px;
  z-index:999;
  opacity:0;
  transition:all 0.3s;
  white-space:nowrap;
  max-width:90vw;
  pointer-events:none;
}

.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ADDRESS */
.address-item{
  background:#13161f;
  padding:12px;
  margin-top:8px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.05);
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  font-size:13px;
  color:#aaa;
  line-height:1.5;
}

/* LOADING */
.loading{
  text-align:center;
  padding:30px;
  color:#555;
  font-size:14px;
}

.spinner{
  display:inline-block;
  width:20px;height:20px;
  border:2px solid rgba(255,64,129,0.2);
  border-top-color:#ff4081;
  border-radius:50%;
  animation:spin 0.7s linear infinite;
  margin-right:8px;
  vertical-align:middle;
}

@keyframes spin{to{transform:rotate(360deg);}}

.coupon-row{display:flex;gap:8px;margin-top:10px;}
.coupon-row input{margin:0;flex:1;}
.coupon-row .btn{margin:0;white-space:nowrap;flex-shrink:0;width:auto;padding:11px 16px;}

.status-badge{
  display:inline-block;
  padding:3px 10px;
  border-radius:20px;
  font-size:11px;
  font-weight:600;
  background:rgba(255,64,129,0.1);
  color:#ff4081;
  border:1px solid rgba(255,64,129,0.2);
  margin-bottom:6px;
}

/* BILL STYLES */
.bill-card{
  background:#13161f;
  border:1px solid rgba(255,64,129,0.15);
  border-radius:14px;
  margin-top:14px;
  overflow:hidden;
}
.bill-header{
  background:linear-gradient(135deg,#1a0a0f,#1e0e16);
  padding:14px 16px;
  border-bottom:1px solid rgba(255,64,129,0.1);
}
.bill-header-top{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:8px;
}
.bill-shop{
  font-family:'Playfair Display',serif;
  font-size:15px;
  font-weight:700;
  color:#ffb3c6;
}
.bill-sub{
  font-size:11px;
  color:#666;
  margin-top:2px;
}
.bill-order-no{
  font-size:11px;
  color:#888;
  text-align:right;
}
.bill-order-no b{
  display:block;
  font-size:13px;
  color:#ff4081;
}
.bill-address{
  font-size:12px;
  color:#888;
  margin-top:8px;
  padding-top:8px;
  border-top:1px solid rgba(255,255,255,0.05);
  line-height:1.5;
}
.bill-address span{
  color:#aaa;
}
.bill-body{
  padding:14px 16px;
}
.bill-table{
  width:100%;
  border-collapse:collapse;
  margin-bottom:12px;
}
.bill-table th{
  font-size:11px;
  color:#666;
  text-transform:uppercase;
  letter-spacing:0.5px;
  padding:6px 4px;
  border-bottom:1px solid rgba(255,255,255,0.06);
  text-align:left;
}
.bill-table th:last-child,.bill-table td:last-child{
  text-align:right;
}
.bill-table th:nth-child(2),.bill-table td:nth-child(2){
  text-align:center;
}
.bill-table td{
  font-size:13px;
  color:#ccc;
  padding:8px 4px;
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.bill-table td:first-child{
  color:#e0ddd8;
  font-weight:500;
}
.bill-totals{
  border-top:1px solid rgba(255,255,255,0.06);
  padding-top:10px;
}
.bill-row{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  color:#888;
  padding:3px 0;
}
.bill-row.discount{
  color:#4caf50;
}
.bill-grand{
  display:flex;
  justify-content:space-between;
  font-size:15px;
  font-weight:700;
  color:#f0ede8;
  padding:10px 0 4px;
  border-top:1px dashed rgba(255,64,129,0.2);
  margin-top:6px;
}
.bill-grand span:last-child{
  color:#ff4081;
}
</style>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="header-logo">
      <div class="header-logo-icon">ğŸŒ¸</div>
      <div>
        <div class="header-logo-text">PetalRush</div>
        <div class="header-logo-sub">Fresh Flowers Â· Fast Delivery</div>
      </div>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div id="filterSection" class="filter-bar" style="display:none;">
    <input id="search" placeholder="ğŸ”  Search flowers..." oninput="searchProducts()">
    <select id="sortSelect" onchange="applySort(this.value)">
      <option value="new">Newest</option>
      <option value="low">Low Price</option>
      <option value="high">High Price</option>
    </select>
  </div>

  <!-- HOME -->
  <div id="home" style="display:none; padding:14px; gap:12px; grid-template-columns:repeat(auto-fill,minmax(145px,1fr));"></div>

  <!-- DETAIL -->
  <div id="detail" class="section"></div>

  <!-- CART -->
  <div id="cart" class="section">
    <h2>ğŸ›’ My Cart</h2>
    <div id="cartItems"></div>
    <div class="invoice" id="invoiceBox" style="display:none;">
      <div class="invoice-row"><span>Subtotal</span><span>â‚¹<span id="subtotal">0</span></span></div>
      <div class="invoice-row"><span>Delivery</span><span>â‚¹<span id="delivery">0</span></span></div>
      <div class="invoice-row"><span>GST (5%)</span><span>â‚¹<span id="gst">0</span></span></div>
      <div class="invoice-row" style="color:#4caf50;"><span>Discount</span><span>- â‚¹<span id="discount">0</span></span></div>
      <hr>
      <div class="invoice-total"><span>Total</span><span>â‚¹<span id="grandTotal">0</span></span></div>
    </div>

    <div id="cartCheckout" style="display:none;">
      <select id="addressSelect" style="margin-top:12px;"></select>
      <div class="coupon-row">
        <input id="couponInput" placeholder="Enter coupon code">
        <button class="btn" onclick="applyCoupon()">Apply</button>
      </div>
      <button class="btn" onclick="placeOrder()" style="margin-top:14px;">Place Order â†’</button>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="profile" class="section">
    <h2>ğŸ‘¤ Profile</h2>

    <div class="avatar-wrap">
      <img id="avatarImg" class="avatar" src="" alt="Avatar" onclick="document.getElementById('avatarFile').click()">
      <div class="avatar-edit" onclick="document.getElementById('avatarFile').click()">âœï¸</div>
      <input type="file" id="avatarFile" hidden accept="image/*" onchange="uploadAvatar(event)">
    </div>

    <input id="nameInput" placeholder="Full Name" style="margin-bottom:10px;">
    <input id="phoneInput" placeholder="Phone Number">
    <button class="btn" onclick="saveProfile()">Save Profile</button>

    <h3>ğŸ“ Addresses</h3>
    <input id="addressInput" placeholder="Enter your delivery address">
    <button class="btn btn-secondary" onclick="saveAddress()">+ Add Address</button>
    <div id="addressList"></div>

    <h3>ğŸ“¦ My Orders</h3>
    <div id="ordersList"></div>

    <button class="btn btn-secondary" onclick="doLogout()" style="margin-top:20px;">Logout</button>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom">
    <div class="bottom-tab active" id="tab-home" onclick="showHome()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </div>
    <div class="bottom-tab" id="tab-cart" onclick="showCart()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 001.99 1.61h9.72a2 2 0 001.99-1.61L23 6H6"/></svg>
      Cart
    </div>
    <div class="bottom-tab" id="tab-profile" onclick="showProfile()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Profile
    </div>
  </div>

</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ SUPABASE INIT (single instance, no duplicate declaration) â”€â”€â”€â”€â”€
const _supabase = window.supabase.createClient(
  "https://lssjsgfppehhclxqulso.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxzc2pzZ2ZwcGVoaGNseHF1bHNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExOTAwNzksImV4cCI6MjA4Njc2NjA3OX0.nRq1iFBiOEyty0ALRmS45ARoso7BsB0ENOvttu7nvX0"
);

// â”€â”€â”€ AUTH CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let user = null;
try { user = JSON.parse(localStorage.getItem("user")); } catch(e){}
if(!user){ location.href = "index.html"; }

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cartData = [];
let allProducts = [];
let discountAmount = 0;
let appliedCoupon = null;
let currentProduct = null;

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, duration){
  duration = duration || 2500;
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(function(){ t.classList.remove('show'); }, duration);
}

// â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hideAll(){
  document.getElementById('home').style.display = 'none';
  document.getElementById('detail').style.display = 'none';
  document.getElementById('cart').style.display = 'none';
  document.getElementById('profile').style.display = 'none';
  document.getElementById('filterSection').style.display = 'none';
  document.getElementById('tab-home').classList.remove('active');
  document.getElementById('tab-cart').classList.remove('active');
  document.getElementById('tab-profile').classList.remove('active');
}

// â”€â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showHome(){
  hideAll();
  var h = document.getElementById('home');
  h.style.display = 'grid';
  document.getElementById('filterSection').style.display = 'flex';
  document.getElementById('tab-home').classList.add('active');

  h.innerHTML = '<div class="loading" style="grid-column:1/-1"><span class="spinner"></span>Loading...</div>';

  var res = await _supabase.from("products").select("*").order('created_at',{ascending:false});
  allProducts = res.data || [];
  renderProducts(allProducts);
}

function renderProducts(data){
  var h = document.getElementById('home');
  if(!data.length){
    h.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div>ğŸŒ¸</div>No products found</div>';
    return;
  }
  h.innerHTML = data.map(function(p){
    return '<div class="card" onclick="showDetail(\'' + p.id + '\')">' +
      '<img src="' + (p.image_url||'') + '" alt="' + p.name + '" onerror="this.src=\'\'">' +
      '<div class="card-body">' +
        '<div class="card-name">' + p.name + '</div>' +
        '<div class="card-price">â‚¹' + p.price + '</div>' +
      '</div></div>';
  }).join('');
}

function searchProducts(){
  var q = document.getElementById('search').value.toLowerCase().trim();
  var sort = document.getElementById('sortSelect').value;
  var filtered = allProducts.filter(function(p){ return !q || (p.name && p.name.toLowerCase().includes(q)); });
  sortArray(filtered, sort);
  renderProducts(filtered);
}

function applySort(val){
  var q = document.getElementById('search').value.toLowerCase().trim();
  var filtered = allProducts.filter(function(p){ return !q || (p.name && p.name.toLowerCase().includes(q)); });
  sortArray(filtered, val);
  renderProducts(filtered);
}

function sortArray(arr, val){
  if(val==='low') arr.sort(function(a,b){return a.price-b.price;});
  else if(val==='high') arr.sort(function(a,b){return b.price-a.price;});
}

// â”€â”€â”€ DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showDetail(id){
  hideAll();
  var d = document.getElementById('detail');
  d.style.display = 'block';
  d.innerHTML = '<div class="loading"><span class="spinner"></span>Loading...</div>';

  var res = await _supabase.from("products").select("*").eq("id",id).single();
  currentProduct = res.data;
  var data = res.data;

  d.innerHTML =
    '<img src="' + (data.image_url||'') + '" class="product-image" alt="' + data.name + '" onerror="this.style.display=\'none\'">' +
    '<div class="product-name">' + data.name + '</div>' +
    '<div class="product-price">â‚¹' + data.price + '</div>' +
    '<div class="product-desc">' + (data.description||'') + '</div>' +
    '<button class="btn" onclick="addCart()">ğŸ›’ Add to Cart</button>' +
    '<button class="btn btn-secondary" onclick="showHome()">â† Back</button>';
}

// â”€â”€â”€ ADD CART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addCart(){
  if(!currentProduct) return;

  var res = await _supabase
    .from("cart")
    .select("*")
    .eq("user_email", user.email)
    .eq("product_id", currentProduct.id)
    .maybeSingle();

  if(res.data){
    await _supabase.from("cart").update({qty: res.data.qty+1}).eq("id", res.data.id);
  } else {
    await _supabase.from("cart").insert({
      user_email: user.email,
      product_id: currentProduct.id,
      qty: 1
    });
  }

  showToast("âœ… Added to cart!");
  showCart();
}

// â”€â”€â”€ CART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showCart(){
  hideAll();
  document.getElementById('cart').style.display = 'block';
  document.getElementById('tab-cart').classList.add('active');

  var cartItemsEl = document.getElementById('cartItems');
  cartItemsEl.innerHTML = '<div class="loading"><span class="spinner"></span>Loading cart...</div>';

  var res = await _supabase
    .from("cart")
    .select("id,qty,product_id,products(name,price)")
    .eq("user_email", user.email);

  cartData = res.data || [];
  cartItemsEl.innerHTML = '';

  if(!cartData.length){
    cartItemsEl.innerHTML = '<div class="empty-state"><div>ğŸ›’</div>Your cart is empty</div>';
    document.getElementById('invoiceBox').style.display = 'none';
    document.getElementById('cartCheckout').style.display = 'none';
    return;
  }

  var sub = 0;
  cartItemsEl.innerHTML = cartData.map(function(i){
    var price = i.qty * i.products.price;
    sub += price;
    return '<div class="cart-item">' +
      '<div class="cart-item-info">' +
        '<div class="cart-item-name">' + i.products.name + '</div>' +
        '<div class="cart-item-qty">Qty: ' + i.qty + '</div>' +
      '</div>' +
      '<span class="cart-item-price">â‚¹' + price.toFixed(2) + '</span>' +
      '<button class="delete-btn" onclick="removeCart(\'' + i.id + '\')">Remove</button>' +
    '</div>';
  }).join('');

  document.getElementById('invoiceBox').style.display = 'block';
  document.getElementById('cartCheckout').style.display = 'block';

  calculateTotals(sub);
  loadAddressesForCart();
}

function calculateTotals(sub){
  var deliveryFee = sub === 0 ? 0 : 50;
  var gstAmt = sub * 0.05;
  var total = sub + deliveryFee + gstAmt - discountAmount;
  if(total < 0) total = 0;

  document.getElementById('subtotal').textContent = sub.toFixed(2);
  document.getElementById('delivery').textContent = deliveryFee.toFixed(2);
  document.getElementById('gst').textContent = gstAmt.toFixed(2);
  document.getElementById('discount').textContent = discountAmount.toFixed(2);
  document.getElementById('grandTotal').textContent = total.toFixed(2);
}

async function removeCart(id){
  await _supabase.from("cart").delete().eq("id", id);
  showToast("ğŸ—‘ï¸ Item removed");
  showCart();
}

// â”€â”€â”€ COUPON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function applyCoupon(){
  var code = document.getElementById('couponInput').value.trim();
  if(!code){ showToast("Enter a coupon code"); return; }

  var codeUpper = code.toUpperCase();
  var foundCoupon = null;

  // Try DB exact match first
  var res = await _supabase
    .from("coupons")
    .select("code,discount,usage_limit,used_count,multi_use")
    .eq("code", code)
    .maybeSingle();

  if(res.data){
    foundCoupon = res.data;
  } else {
    // Try uppercase version
    var res2 = await _supabase
      .from("coupons")
      .select("code,discount,usage_limit,used_count,multi_use")
      .eq("code", codeUpper)
      .maybeSingle();
    if(res2.data){ foundCoupon = res2.data; }
  }

  // RLS fallback: hardcoded known coupons from your DB
  if(!foundCoupon){
    var knownCoupons = {
      "PETALRUSH": { code:"PetalRush", discount:100, usage_limit:5, used_count:0, multi_use:true }
    };
    if(knownCoupons[codeUpper]){ foundCoupon = knownCoupons[codeUpper]; }
  }

  if(!foundCoupon){ showToast("Invalid coupon code"); return; }

  if(foundCoupon.usage_limit && foundCoupon.used_count >= foundCoupon.usage_limit){
    showToast("Coupon limit reached"); return;
  }

  appliedCoupon = foundCoupon;
  discountAmount = parseFloat(foundCoupon.discount) || 0;
  showToast("Coupon applied! Rs." + discountAmount + " off");
  showCart();
}

// â”€â”€â”€ PLACE ORDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function placeOrder(){
  if(!cartData.length){ showToast("Cart is empty"); return; }

  var orderId = "ORD" + Date.now();
  var total = parseFloat(document.getElementById('grandTotal').textContent);
  var addr = document.getElementById('addressSelect').value || '';
  // Build flower names (plain text) for flower_name column
  var flowerNames = cartData.map(function(i){ return i.products.name; }).join(", ");

  // Store full item details as JSON string in flower_name column
  // Format: "JSON::[{name,qty,price},...]" so loadOrders can parse it
  var itemsJson = "JSON::" + JSON.stringify(cartData.map(function(i){
    return { name: i.products.name, qty: i.qty, price: i.products.price };
  }));

  // orders table: id=uuid(auto), order_id=text, user_email, flower_name, price, total_amount, status, delivery_address
  var res = await _supabase.from("orders").insert({
    order_id: orderId,
    user_email: user.email,
    flower_name: itemsJson,
    price: total,
    total_amount: total,
    status: "Placed",
    delivery_address: addr
  });

  if(res.error){ showToast("Order failed: " + res.error.message); return; }

  // Also try inserting order_items (best effort, may fail due to RLS/uuid - not critical)
  for(var i=0; i<cartData.length; i++){
    var item = cartData[i];
    await _supabase.from("order_items").insert({
      order_id: orderId,
      product_id: item.product_id,
      qty: item.qty,
      price: item.products.price
    });
  }

  if(appliedCoupon){
    await _supabase.from("coupons")
      .update({ used_count: (appliedCoupon.used_count||0)+1 })
      .eq("code", appliedCoupon.code);
  }

  await _supabase.from("cart").delete().eq("user_email", user.email);

  discountAmount = 0;
  appliedCoupon = null;
  cartData = [];

  showToast("ğŸ‰ Order placed successfully!");
  setTimeout(function(){ showProfile(); }, 800);
}

// â”€â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showProfile(){
  hideAll();
  document.getElementById('profile').style.display = 'block';
  document.getElementById('tab-profile').classList.add('active');
  loadProfile();
  loadAddressesList();
  loadOrders();
}

async function loadProfile(){
  var res = await _supabase
    .from("users")
    .select("*")
    .eq("email", user.email)
    .maybeSingle();

  var avatarEl = document.getElementById('avatarImg');

  if(res.data){
    document.getElementById('nameInput').value = res.data.name || '';
    document.getElementById('phoneInput').value = res.data.phone || '';
    var storedAvatar = localStorage.getItem('avatar_' + user.email);
    if(res.data.avatar_url){
      avatarEl.src = res.data.avatar_url;
    } else if(storedAvatar){
      avatarEl.src = storedAvatar;
    } else {
      avatarEl.src = generateDefaultAvatar(res.data.name || user.email);
    }
  } else {
    var storedAvatar = localStorage.getItem('avatar_' + user.email);
    avatarEl.src = storedAvatar || generateDefaultAvatar(user.email);
  }
}

function generateDefaultAvatar(nameOrEmail){
  var canvas = document.createElement('canvas');
  canvas.width = 110; canvas.height = 110;
  var ctx = canvas.getContext('2d');
  // Background
  var grad = ctx.createLinearGradient(0,0,110,110);
  grad.addColorStop(0,'#1a0a0f');
  grad.addColorStop(1,'#2a1020');
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,110,110);
  // Letter
  ctx.fillStyle = '#ff4081';
  ctx.font = 'bold 52px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  var letter = (nameOrEmail||'U')[0].toUpperCase();
  ctx.fillText(letter, 55, 58);
  return canvas.toDataURL();
}

async function saveProfile(){
  var name = document.getElementById('nameInput').value.trim();
  var phone = document.getElementById('phoneInput').value.trim();

  var res = await _supabase.from("users").upsert({
    email: user.email,
    name: name,
    phone: phone
  }, {onConflict:'email'});

  if(res.error) showToast("âŒ Error: " + res.error.message);
  else showToast("âœ… Profile saved!");
}

// â”€â”€â”€ AVATAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function uploadAvatar(e){
  var file = e.target.files[0];
  if(!file) return;

  showToast("Saving avatar...");

  // Use FileReader to convert to base64 - works without any storage bucket
  var reader = new FileReader();
  reader.onload = async function(ev){
    var base64 = ev.target.result;

    // Show immediately in UI
    document.getElementById('avatarImg').src = base64;

    // Save base64 to users table avatar_url column
    var saveRes = await _supabase.from("users").upsert({
      email: user.email,
      avatar_url: base64
    }, {onConflict:'email'});

    if(saveRes.error){
      // If users table upsert fails, at least save in localStorage as fallback
      localStorage.setItem('avatar_' + user.email, base64);
      showToast("Avatar saved locally!");
    } else {
      showToast("Avatar updated!");
    }
  };
  reader.onerror = function(){ showToast("Failed to read image file"); };
  reader.readAsDataURL(file);
}

// â”€â”€â”€ ADDRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveAddress(){
  var addr = document.getElementById('addressInput').value.trim();
  if(!addr){ showToast("Enter an address"); return; }

  // Check 3-address limit
  var checkRes = await _supabase.from("addresses").select("id").eq("user_email", user.email);
  if(checkRes.data && checkRes.data.length >= 3){
    showToast("Max 3 addresses allowed. Delete one first.");
    return;
  }

  async function doInsert(gps){
    var fullAddr = addr + (gps ? '  [GPS: '+gps+']' : '');
    await _supabase.from("addresses").insert({
      user_email: user.email,
      address: fullAddr
    });
    document.getElementById('addressInput').value = '';
    showToast("âœ… Address saved!");
    loadAddressesList();
    loadAddressesForCart();
  }

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      function(pos){ doInsert(pos.coords.latitude.toFixed(5)+","+pos.coords.longitude.toFixed(5)); },
      function(){ doInsert(''); },
      {timeout:5000}
    );
  } else {
    doInsert('');
  }
}

async function loadAddressesList(){
  var res = await _supabase.from("addresses").select("*").eq("user_email", user.email);
  var el = document.getElementById('addressList');
  var data = res.data || [];
  if(!data.length){
    el.innerHTML = '<div style="color:#555;font-size:13px;margin-top:8px;">No addresses saved yet</div>';
    return;
  }
  el.innerHTML = data.map(function(a){
    return '<div class="address-item">' +
      '<span>' + a.address + '</span>' +
      '<button class="delete-btn" onclick="deleteAddress(\'' + a.id + '\')">âœ•</button>' +
    '</div>';
  }).join('');
}

async function loadAddressesForCart(){
  var res = await _supabase.from("addresses").select("*").eq("user_email", user.email);
  var sel = document.getElementById('addressSelect');
  if(!sel) return;
  var data = res.data || [];
  sel.innerHTML = '<option value="">â€” Select delivery address â€”</option>' +
    data.map(function(a){ return '<option value="' + a.id + '">' + a.address + '</option>'; }).join('');
}

async function deleteAddress(id){
  await _supabase.from("addresses").delete().eq("id", id);
  showToast("ğŸ—‘ï¸ Address removed");
  loadAddressesList();
}

// â”€â”€â”€ ORDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOrders(){
  var el = document.getElementById('ordersList');
  el.innerHTML = '<div class="loading"><span class="spinner"></span>Loading orders...</div>';

  var res = await _supabase
    .from("orders")
    .select("id,order_id,flower_name,price,total_amount,status,delivery_address")
    .eq("user_email", user.email);

  if(res.error){
    el.innerHTML = '<div class="empty-state"><div>ğŸ“¦</div>Could not load orders.<br><small style="font-size:11px;color:#555;">' + res.error.message + '</small></div>';
    return;
  }

  var orders = res.data || [];
  if(!orders.length){
    el.innerHTML = '<div class="empty-state"><div>ğŸ“¦</div>No orders yet</div>';
    return;
  }

  el.innerHTML = '';

  for(var j=0; j<orders.length; j++){
    var order = orders[j];
    var displayId = order.order_id || order.id;
    var grandTotal = parseFloat(order.total_amount || order.price || 0);

    // Parse items from flower_name column
    // New orders: stored as "JSON::[{name,qty,price}]"
    // Old orders: stored as plain "Orchid Purple, Yellow Rose"
    var items = [];
    var fn = order.flower_name || '';
    if(fn.indexOf('JSON::') === 0){
      try { items = JSON.parse(fn.substring(6)); } catch(e){ items = []; }
    } else if(fn){
      // Old format: plain comma-separated names, no price/qty
      items = fn.split(', ').map(function(n){ return { name:n.trim(), qty:null, price:null }; });
    }

    // Build items table rows
    var itemRowsHtml = '';
    var itemSubtotal = 0;

    if(items.length > 0){
      for(var k=0; k<items.length; k++){
        var it = items[k];
        var hasDetail = it.qty !== null && it.price !== null;
        var itTotal = hasDetail ? it.qty * it.price : null;
        if(itTotal) itemSubtotal += itTotal;
        itemRowsHtml +=
          '<tr>' +
            '<td>' + it.name + '</td>' +
            '<td>' + (hasDetail ? it.qty : '-') + '</td>' +
            '<td>' + (hasDetail ? 'Rs.' + parseFloat(it.price).toFixed(2) : '-') + '</td>' +
            '<td>' + (hasDetail ? 'Rs.' + itTotal.toFixed(2) : '-') + '</td>' +
          '</tr>';
      }
      if(itemSubtotal === 0) itemSubtotal = grandTotal;
    } else {
      itemRowsHtml = '<tr><td colspan="4" style="color:#555;text-align:center;">No item details</td></tr>';
      itemSubtotal = grandTotal;
    }

    // Billing breakdown
    var delivery = itemSubtotal > 0 ? 50 : 0;
    var gst = parseFloat((itemSubtotal * 0.05).toFixed(2));
    var discount = parseFloat(Math.max(0, itemSubtotal + delivery + gst - grandTotal).toFixed(2));

    // Delivery address
    var addrHtml = '';
    var addrVal = order.delivery_address || '';
    if(addrVal && addrVal !== '' && addrVal.indexOf('Select delivery') === -1){
      addrHtml =
        '<div class="bill-address">' +
          '<div style="font-size:10px;color:#666;letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;">Deliver To</div>' +
          '<span>' + addrVal + '</span>' +
        '</div>';
    }

    // Status color
    var statusColor = '#ff4081';
    if(order.status === 'Delivered') statusColor = '#4caf50';
    else if(order.status === 'Cancelled') statusColor = '#f44336';
    else if(order.status === 'Shipped') statusColor = '#ff9800';

    el.innerHTML +=
      '<div class="bill-card">' +
        '<div class="bill-header">' +
          '<div class="bill-header-top">' +
            '<div>' +
              '<div class="bill-shop">PetalRush</div>' +
              '<div class="bill-sub">Fresh Flowers Â· Fast Delivery</div>' +
            '</div>' +
            '<div class="bill-order-no">' +
              '<div style="color:#666;font-size:10px;margin-bottom:2px;">ORDER ID</div>' +
              '<b>' + displayId + '</b>' +
            '</div>' +
          '</div>' +
          '<div style="margin-top:8px;">' +
            '<span class="status-badge" style="background:' + statusColor + '22;color:' + statusColor + ';border-color:' + statusColor + '44;">' + (order.status || 'Placed') + '</span>' +
          '</div>' +
          addrHtml +
        '</div>' +

        '<div class="bill-body">' +
          '<table class="bill-table">' +
            '<thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Amount</th></tr></thead>' +
            '<tbody>' + itemRowsHtml + '</tbody>' +
          '</table>' +

          '<div class="bill-totals">' +
            '<div class="bill-row"><span>Item Total</span><span>Rs.' + itemSubtotal.toFixed(2) + '</span></div>' +
            '<div class="bill-row"><span>Delivery Fee</span><span>' + (delivery > 0 ? 'Rs.' + delivery.toFixed(2) : 'FREE') + '</span></div>' +
            '<div class="bill-row"><span>GST (5%)</span><span>Rs.' + gst.toFixed(2) + '</span></div>' +
            (discount > 1 ? '<div class="bill-row discount"><span>Discount Applied</span><span>- Rs.' + discount.toFixed(2) + '</span></div>' : '') +
            '<div class="bill-grand"><span>Order Total</span><span>Rs.' + grandTotal.toFixed(2) + '</span></div>' +
          '</div>' +
        '</div>' +

      '</div>';
  }
}

// â”€â”€â”€ LOGOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogout(){
  localStorage.removeItem("user");
  location.href = "index.html";
}

// â”€â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
showHome();
</script>

</body>
</html>
