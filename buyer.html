<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PetalRush Buyer</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


<style>
*{box-sizing:border-box;margin:0;padding:0;}

body{
  background:#0d0f14;
  color:#f0ede8;
  font-family:'DM Sans',sans-serif;
  min-height:100vh;
}

.container{
  max-width:500px;
  margin:auto;
  padding-bottom:85px;
  position:relative;
}

/* HEADER */
.header{
  background:linear-gradient(135deg,#1a0a0f 0%,#0d0f14 100%);
  padding:14px 20px;
  text-align:center;
  border-bottom:1px solid rgba(255,80,100,0.15);
  position:sticky;
  top:0;
  z-index:100;
  backdrop-filter:blur(10px);
}

.header-logo{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}

.header-logo-icon{
  width:38px;height:38px;
  background:linear-gradient(135deg,#ff4081,#ff6b6b);
  border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;
  box-shadow:0 4px 15px rgba(255,64,129,0.4);
}

.header-logo-text{
  font-family:'Playfair Display',serif;
  font-size:22px;
  font-weight:700;
  background:linear-gradient(135deg,#ff4081,#ffb3c6);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  letter-spacing:0.5px;
}

.header-logo-sub{
  font-size:10px;
  color:#888;
  letter-spacing:2px;
  text-transform:uppercase;
  margin-top:-2px;
}

/* FILTER BAR */
.filter-bar{
  padding:12px 14px;
  background:#111318;
  display:flex;
  gap:10px;
  border-bottom:1px solid rgba(255,255,255,0.04);
}

input,select{
  flex:1;
  padding:11px 14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.08);
  background:#1a1d26;
  color:#f0ede8;
  font-family:'DM Sans',sans-serif;
  font-size:14px;
  outline:none;
  transition:border 0.2s;
}

input:focus,select:focus{
  border-color:rgba(255,64,129,0.4);
}

input::placeholder{color:#555;}

select option{background:#1a1d26;}

/* PRODUCTS GRID */
#home{
  display:none;
  padding:14px;
  gap:12px;
  grid-template-columns:repeat(auto-fill,minmax(145px,1fr));
}

.card{
  background:#13161f;
  border-radius:14px;
  overflow:hidden;
  cursor:pointer;
  border:1px solid rgba(255,255,255,0.05);
  transition:transform 0.2s,box-shadow 0.2s,border-color 0.2s;
}

.card:hover{
  transform:translateY(-3px);
  box-shadow:0 10px 30px rgba(255,64,129,0.15);
  border-color:rgba(255,64,129,0.2);
}

.card img{
  width:100%;
  height:130px;
  object-fit:cover;
  display:block;
  background:#1a1d26;
}

.card-body{
  padding:10px;
}

.card-name{
  font-size:13px;
  font-weight:500;
  color:#e0ddd8;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  margin-bottom:4px;
}

.card-price{
  font-size:14px;
  font-weight:600;
  color:#ff4081;
}

/* SECTIONS */
.section{display:none;padding:14px;}

.section h2{
  font-family:'Playfair Display',serif;
  font-size:22px;
  margin-bottom:16px;
  color:#f0ede8;
}

.section h3{
  font-size:15px;
  font-weight:600;
  margin:20px 0 10px;
  color:#ccc;
}

/* BUTTONS */
.btn{
  background:linear-gradient(135deg,#ff4081,#e0205f);
  border:none;
  padding:13px;
  width:100%;
  border-radius:10px;
  color:white;
  margin-top:10px;
  cursor:pointer;
  font-family:'DM Sans',sans-serif;
  font-size:15px;
  font-weight:500;
  letter-spacing:0.3px;
  transition:opacity 0.2s,transform 0.1s;
  box-shadow:0 4px 15px rgba(255,64,129,0.25);
}

.btn:hover{opacity:0.9;transform:translateY(-1px);}
.btn:active{transform:translateY(0);}

.btn-secondary{
  background:#1a1d26;
  border:1px solid rgba(255,255,255,0.1);
  box-shadow:none;
}

.btn-secondary:hover{border-color:rgba(255,64,129,0.3);opacity:1;}

/* DETAIL */
#detail .product-image{
  width:100%;
  border-radius:14px;
  object-fit:cover;
  max-height:280px;
  background:#1a1d26;
}

#detail .product-name{
  font-family:'Playfair Display',serif;
  font-size:22px;
  margin:14px 0 6px;
}

#detail .product-price{
  font-size:20px;
  font-weight:600;
  color:#ff4081;
  margin-bottom:6px;
}

#detail .product-desc{
  font-size:14px;
  color:#888;
  line-height:1.6;
  margin-bottom:14px;
}

/* CART */
.cart-item{
  background:#13161f;
  padding:14px;
  margin-top:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.05);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.cart-item-info{
  flex:1;
}

.cart-item-name{
  font-size:14px;
  font-weight:500;
  color:#e0ddd8;
  margin-bottom:4px;
}

.cart-item-qty{
  font-size:12px;
  color:#888;
}

.cart-item-price{
  font-size:15px;
  font-weight:600;
  color:#ff4081;
  margin-right:10px;
}

.delete-btn{
  background:rgba(255,64,81,0.1);
  border:1px solid rgba(255,64,81,0.2);
  color:#ff4081;
  padding:6px 12px;
  border-radius:8px;
  cursor:pointer;
  font-size:12px;
  transition:background 0.2s;
}

.delete-btn:hover{background:rgba(255,64,81,0.2);}

/* INVOICE */
.invoice{
  background:#13161f;
  padding:16px;
  margin-top:14px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.06);
  font-size:14px;
  line-height:2;
}

.invoice hr{
  border:none;
  border-top:1px solid rgba(255,255,255,0.06);
  margin:8px 0;
}

.invoice-row{
  display:flex;
  justify-content:space-between;
}

.invoice-total{
  display:flex;
  justify-content:space-between;
  font-size:16px;
  font-weight:700;
  color:#f0ede8;
}

/* BOTTOM NAV */
.bottom{
  position:fixed;
  bottom:0;
  width:100%;
  max-width:500px;
  display:flex;
  background:#111318;
  border-top:1px solid rgba(255,255,255,0.06);
  z-index:100;
}

.bottom-tab{
  flex:1;
  text-align:center;
  padding:14px 0 12px;
  cursor:pointer;
  font-size:12px;
  color:#666;
  transition:color 0.2s;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
}

.bottom-tab.active{color:#ff4081;}

.bottom-tab svg{
  width:22px;height:22px;
}

/* AVATAR */
.avatar-wrap{
  display:flex;
  justify-content:center;
  margin-bottom:20px;
  position:relative;
  width:fit-content;
  margin-left:auto;
  margin-right:auto;
}

.avatar{
  width:110px;height:110px;
  border-radius:50%;
  border:3px solid #ff4081;
  object-fit:cover;
  cursor:pointer;
  background:#1a1d26;
  display:block;
  transition:opacity 0.2s;
}

.avatar:hover{opacity:0.85;}

.avatar-edit{
  position:absolute;
  bottom:4px;
  right:0px;
  background:#ff4081;
  border-radius:50%;
  width:28px;height:28px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  box-shadow:0 2px 8px rgba(0,0,0,0.4);
  font-size:13px;
}

/* ORDER CARD */
.order-card{
  background:#13161f;
  border:1px solid rgba(255,255,255,0.05);
  border-radius:12px;
  padding:14px;
  margin-top:10px;
}

.order-id{
  font-size:12px;
  color:#888;
  margin-bottom:6px;
}

.order-total{
  font-size:16px;
  font-weight:700;
  color:#ff4081;
  margin-bottom:10px;
}

.order-item-line{
  font-size:13px;
  color:#aaa;
  padding:3px 0;
  border-bottom:1px solid rgba(255,255,255,0.04);
}

/* EMPTY STATE */
.empty-state{
  text-align:center;
  padding:40px 20px;
  color:#555;
}

.empty-state div{font-size:40px;margin-bottom:10px;}

/* TOAST */
.toast{
  position:fixed;
  bottom:90px;
  left:50%;
  transform:translateX(-50%) translateY(20px);
  background:#1e2130;
  border:1px solid rgba(255,64,129,0.3);
  color:#f0ede8;
  padding:12px 22px;
  border-radius:25px;
  font-size:14px;
  z-index:999;
  opacity:0;
  transition:all 0.3s;
  white-space:nowrap;
  max-width:90vw;
  pointer-events:none;
}

.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ADDRESS */
.address-item{
  background:#13161f;
  padding:12px;
  margin-top:8px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.05);
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  font-size:13px;
  color:#aaa;
  line-height:1.5;
}

/* LOADING */
.loading{
  text-align:center;
  padding:30px;
  color:#555;
  font-size:14px;
}

.spinner{
  display:inline-block;
  width:20px;height:20px;
  border:2px solid rgba(255,64,129,0.2);
  border-top-color:#ff4081;
  border-radius:50%;
  animation:spin 0.7s linear infinite;
  margin-right:8px;
  vertical-align:middle;
}

@keyframes spin{to{transform:rotate(360deg);}}

.coupon-row{display:flex;gap:8px;margin-top:10px;}
.coupon-row input{margin:0;flex:1;}
.coupon-row .btn{margin:0;white-space:nowrap;flex-shrink:0;width:auto;padding:11px 16px;}

.status-badge{
  display:inline-block;
  padding:3px 10px;
  border-radius:20px;
  font-size:11px;
  font-weight:600;
  background:rgba(255,64,129,0.1);
  color:#ff4081;
  border:1px solid rgba(255,64,129,0.2);
  margin-bottom:6px;
}
</style>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="header-logo">
      <div class="header-logo-icon"><img src="HeaderLogo.png" class="logo" alt="PetalRush"></div>
      <div>
        <div class="header-logo-text">PetalRush</div>
        <div class="header-logo-sub">Fresh Flowers Â· Fast Delivery</div>
      </div>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div id="filterSection" class="filter-bar" style="display:none;">
    <input id="search" placeholder="ğŸ”  Search flowers..." oninput="searchProducts()">
    <select id="sortSelect" onchange="applySort(this.value)">
      <option value="new">Newest</option>
      <option value="low">Low Price</option>
      <option value="high">High Price</option>
    </select>
  </div>

  <!-- HOME -->
  <div id="home" style="display:none; padding:14px; gap:12px; grid-template-columns:repeat(auto-fill,minmax(145px,1fr));"></div>

  <!-- DETAIL -->
  <div id="detail" class="section"></div>

  <!-- CART -->
  <div id="cart" class="section">
    <h2>ğŸ›’ My Cart</h2>
    <div id="cartItems"></div>
    <div class="invoice" id="invoiceBox" style="display:none;">
      <div class="invoice-row"><span>Subtotal</span><span>â‚¹<span id="subtotal">0</span></span></div>
      <div class="invoice-row"><span>Delivery</span><span>â‚¹<span id="delivery">0</span></span></div>
      <div class="invoice-row"><span>GST (5%)</span><span>â‚¹<span id="gst">0</span></span></div>
      <div class="invoice-row" style="color:#4caf50;"><span>Discount</span><span>- â‚¹<span id="discount">0</span></span></div>
      <hr>
      <div class="invoice-total"><span>Total</span><span>â‚¹<span id="grandTotal">0</span></span></div>
    </div>

    <div id="cartCheckout" style="display:none;">
      <select id="addressSelect" style="margin-top:12px;"></select>
      <div class="coupon-row">
        <input id="couponInput" placeholder="Enter coupon code">
        <button class="btn" onclick="applyCoupon()">Apply</button>
      </div>
      <button class="btn" onclick="placeOrder()" style="margin-top:14px;">Place Order â†’</button>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="profile" class="section">
    <h2>ğŸ‘¤ Profile</h2>

    <div class="avatar-wrap">
      <img id="avatarImg" class="avatar" src="" alt="Avatar" onclick="document.getElementById('avatarFile').click()">
      <div class="avatar-edit" onclick="document.getElementById('avatarFile').click()">âœï¸</div>
      <input type="file" id="avatarFile" hidden accept="image/*" onchange="uploadAvatar(event)">
    </div>

    <input id="nameInput" placeholder="Full Name" style="margin-bottom:10px;">
    <input id="phoneInput" placeholder="Phone Number">
    <button class="btn" onclick="saveProfile()">Save Profile</button>

    <h3>ğŸ“ Addresses</h3>
    <input id="addressInput" placeholder="Enter your delivery address">
    <button class="btn btn-secondary" onclick="saveAddress()">+ Add Address</button>
    <div id="addressList"></div>

    <h3>ğŸ“¦ My Orders</h3>
    <div id="ordersList"></div>

    <button class="btn btn-secondary" onclick="doLogout()" style="margin-top:20px;">Logout</button>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom">
    <div class="bottom-tab active" id="tab-home" onclick="showHome()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </div>
    <div class="bottom-tab" id="tab-cart" onclick="showCart()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 001.99 1.61h9.72a2 2 0 001.99-1.61L23 6H6"/></svg>
      Cart
    </div>
    <div class="bottom-tab" id="tab-profile" onclick="showProfile()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Profile
    </div>
  </div>

</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ SUPABASE INIT (single instance, no duplicate declaration) â”€â”€â”€â”€â”€
const _supabase = window.supabase.createClient(
  "https://lssjsgfppehhclxqulso.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxzc2pzZ2ZwcGVoaGNseHF1bHNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExOTAwNzksImV4cCI6MjA4Njc2NjA3OX0.nRq1iFBiOEyty0ALRmS45ARoso7BsB0ENOvttu7nvX0"
);

// â”€â”€â”€ AUTH CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let user = null;
try { user = JSON.parse(localStorage.getItem("user")); } catch(e){}
if(!user){ location.href = "index.html"; }

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cartData = [];
let allProducts = [];
let discountAmount = 0;
let appliedCoupon = null;
let currentProduct = null;

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, duration){
  duration = duration || 2500;
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(function(){ t.classList.remove('show'); }, duration);
}

// â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hideAll(){
  document.getElementById('home').style.display = 'none';
  document.getElementById('detail').style.display = 'none';
  document.getElementById('cart').style.display = 'none';
  document.getElementById('profile').style.display = 'none';
  document.getElementById('filterSection').style.display = 'none';
  document.getElementById('tab-home').classList.remove('active');
  document.getElementById('tab-cart').classList.remove('active');
  document.getElementById('tab-profile').classList.remove('active');
}

// â”€â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showHome(){
  hideAll();
  var h = document.getElementById('home');
  h.style.display = 'grid';
  document.getElementById('filterSection').style.display = 'flex';
  document.getElementById('tab-home').classList.add('active');

  h.innerHTML = '<div class="loading" style="grid-column:1/-1"><span class="spinner"></span>Loading...</div>';

  var res = await _supabase.from("products").select("*").order('created_at',{ascending:false});
  allProducts = res.data || [];
  renderProducts(allProducts);
}

function renderProducts(data){
  var h = document.getElementById('home');
  if(!data.length){
    h.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div>ğŸŒ¸</div>No products found</div>';
    return;
  }
  h.innerHTML = data.map(function(p){
    return '<div class="card" onclick="showDetail(\'' + p.id + '\')">' +
      '<img src="' + (p.image_url||'') + '" alt="' + p.name + '" onerror="this.src=\'\'">' +
      '<div class="card-body">' +
        '<div class="card-name">' + p.name + '</div>' +
        '<div class="card-price">â‚¹' + p.price + '</div>' +
      '</div></div>';
  }).join('');
}

function searchProducts(){
  var q = document.getElementById('search').value.toLowerCase().trim();
  var sort = document.getElementById('sortSelect').value;
  var filtered = allProducts.filter(function(p){ return !q || (p.name && p.name.toLowerCase().includes(q)); });
  sortArray(filtered, sort);
  renderProducts(filtered);
}

function applySort(val){
  var q = document.getElementById('search').value.toLowerCase().trim();
  var filtered = allProducts.filter(function(p){ return !q || (p.name && p.name.toLowerCase().includes(q)); });
  sortArray(filtered, val);
  renderProducts(filtered);
}

function sortArray(arr, val){
  if(val==='low') arr.sort(function(a,b){return a.price-b.price;});
  else if(val==='high') arr.sort(function(a,b){return b.price-a.price;});
}

// â”€â”€â”€ DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showDetail(id){
  hideAll();
  var d = document.getElementById('detail');
  d.style.display = 'block';
  d.innerHTML = '<div class="loading"><span class="spinner"></span>Loading...</div>';

  var res = await _supabase.from("products").select("*").eq("id",id).single();
  currentProduct = res.data;
  var data = res.data;

  d.innerHTML =
    '<img src="' + (data.image_url||'') + '" class="product-image" alt="' + data.name + '" onerror="this.style.display=\'none\'">' +
    '<div class="product-name">' + data.name + '</div>' +
    '<div class="product-price">â‚¹' + data.price + '</div>' +
    '<div class="product-desc">' + (data.description||'') + '</div>' +
    '<button class="btn" onclick="addCart()">ğŸ›’ Add to Cart</button>' +
    '<button class="btn btn-secondary" onclick="showHome()">â† Back</button>';
}

// â”€â”€â”€ ADD CART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addCart(){
  if(!currentProduct) return;

  var res = await _supabase
    .from("cart")
    .select("*")
    .eq("user_email", user.email)
    .eq("product_id", currentProduct.id)
    .maybeSingle();

  if(res.data){
    await _supabase.from("cart").update({qty: res.data.qty+1}).eq("id", res.data.id);
  } else {
    await _supabase.from("cart").insert({
      user_email: user.email,
      product_id: currentProduct.id,
      qty: 1
    });
  }

  showToast("âœ… Added to cart!");
  showCart();
}

// â”€â”€â”€ CART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showCart(){
  hideAll();
  document.getElementById('cart').style.display = 'block';
  document.getElementById('tab-cart').classList.add('active');

  var cartItemsEl = document.getElementById('cartItems');
  cartItemsEl.innerHTML = '<div class="loading"><span class="spinner"></span>Loading cart...</div>';

  var res = await _supabase
    .from("cart")
    .select("id,qty,product_id,products(name,price)")
    .eq("user_email", user.email);

  cartData = res.data || [];
  cartItemsEl.innerHTML = '';

  if(!cartData.length){
    cartItemsEl.innerHTML = '<div class="empty-state"><div>ğŸ›’</div>Your cart is empty</div>';
    document.getElementById('invoiceBox').style.display = 'none';
    document.getElementById('cartCheckout').style.display = 'none';
    return;
  }

  var sub = 0;
  cartItemsEl.innerHTML = cartData.map(function(i){
    var price = i.qty * i.products.price;
    sub += price;
    return '<div class="cart-item">' +
      '<div class="cart-item-info">' +
        '<div class="cart-item-name">' + i.products.name + '</div>' +
        '<div class="cart-item-qty">Qty: ' + i.qty + '</div>' +
      '</div>' +
      '<span class="cart-item-price">â‚¹' + price.toFixed(2) + '</span>' +
      '<button class="delete-btn" onclick="removeCart(\'' + i.id + '\')">Remove</button>' +
    '</div>';
  }).join('');

  document.getElementById('invoiceBox').style.display = 'block';
  document.getElementById('cartCheckout').style.display = 'block';

  calculateTotals(sub);
  loadAddressesForCart();
}

function calculateTotals(sub){
  var deliveryFee = sub === 0 ? 0 : 50;
  var gstAmt = sub * 0.05;
  var total = sub + deliveryFee + gstAmt - discountAmount;
  if(total < 0) total = 0;

  document.getElementById('subtotal').textContent = sub.toFixed(2);
  document.getElementById('delivery').textContent = deliveryFee.toFixed(2);
  document.getElementById('gst').textContent = gstAmt.toFixed(2);
  document.getElementById('discount').textContent = discountAmount.toFixed(2);
  document.getElementById('grandTotal').textContent = total.toFixed(2);
}

async function removeCart(id){
  await _supabase.from("cart").delete().eq("id", id);
  showToast("ğŸ—‘ï¸ Item removed");
  showCart();
}

// â”€â”€â”€ COUPON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function applyCoupon(){
  var code = document.getElementById('couponInput').value.trim();
  if(!code){ showToast("Enter a coupon code"); return; }

  // Try exact match first (case-sensitive), then uppercase
  var res = await _supabase
    .from("coupons")
    .select("code,discount,usage_limit,used_count,multi_use")
    .eq("code", code)
    .maybeSingle();

  // If not found, try uppercase version
  if(!res.data && !res.error){
    res = await _supabase
      .from("coupons")
      .select("code,discount,usage_limit,used_count,multi_use")
      .eq("code", code.toUpperCase())
      .maybeSingle();
  }

  if(res.error){ showToast("âŒ Error checking coupon: " + res.error.message); return; }
  if(!res.data){ showToast("âŒ Invalid coupon code"); return; }

  var data = res.data;
  if(data.usage_limit && data.used_count >= data.usage_limit){
    showToast("âš ï¸ Coupon usage limit reached"); return;
  }

  appliedCoupon = data;
  discountAmount = parseFloat(data.discount) || 0;
  showToast("âœ… Coupon applied! â‚¹" + discountAmount + " off");
  showCart();
}

// â”€â”€â”€ PLACE ORDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function placeOrder(){
  if(!cartData.length){ showToast("Cart is empty"); return; }

  var orderId = "ORD" + Date.now();
  var total = parseFloat(document.getElementById('grandTotal').textContent);
  var addr = document.getElementById('addressSelect').value || '';
  // Build flower names list for the flower_name column
  var flowerNames = cartData.map(function(i){ return i.products.name; }).join(", ");

  // orders table: id=uuid(auto), order_id=text, user_email, flower_name, price, total_amount, status, delivery_address
  var res = await _supabase.from("orders").insert({
    order_id: orderId,
    user_email: user.email,
    flower_name: flowerNames,
    price: total,
    total_amount: total,
    status: "Placed",
    delivery_address: addr
  });

  if(res.error){ showToast("Order failed: " + res.error.message); return; }

  // Fetch the inserted order's uuid id for order_items
  var orderRes = await _supabase.from("orders").select("id").eq("order_id", orderId).single();
  var orderUUID = orderRes.data ? orderRes.data.id : orderId;

  for(var i=0; i<cartData.length; i++){
    var item = cartData[i];
    await _supabase.from("order_items").insert({
      order_id: orderUUID,
      product_id: item.product_id,
      qty: item.qty,
      price: item.products.price
    });
  }

  if(appliedCoupon){
    await _supabase.from("coupons")
      .update({ used_count: (appliedCoupon.used_count||0)+1 })
      .eq("code", appliedCoupon.code);
  }

  await _supabase.from("cart").delete().eq("user_email", user.email);

  discountAmount = 0;
  appliedCoupon = null;
  cartData = [];

  showToast("ğŸ‰ Order placed successfully!");
  setTimeout(function(){ showProfile(); }, 800);
}

// â”€â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showProfile(){
  hideAll();
  document.getElementById('profile').style.display = 'block';
  document.getElementById('tab-profile').classList.add('active');
  loadProfile();
  loadAddressesList();
  loadOrders();
}

async function loadProfile(){
  var res = await _supabase
    .from("users")
    .select("*")
    .eq("email", user.email)
    .maybeSingle();

  var avatarEl = document.getElementById('avatarImg');

  if(res.data){
    document.getElementById('nameInput').value = res.data.name || '';
    document.getElementById('phoneInput').value = res.data.phone || '';
    if(res.data.avatar_url){
      avatarEl.src = res.data.avatar_url;
    } else {
      avatarEl.src = generateDefaultAvatar(res.data.name || user.email);
    }
  } else {
    avatarEl.src = generateDefaultAvatar(user.email);
  }
}

function generateDefaultAvatar(nameOrEmail){
  var canvas = document.createElement('canvas');
  canvas.width = 110; canvas.height = 110;
  var ctx = canvas.getContext('2d');
  // Background
  var grad = ctx.createLinearGradient(0,0,110,110);
  grad.addColorStop(0,'#1a0a0f');
  grad.addColorStop(1,'#2a1020');
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,110,110);
  // Letter
  ctx.fillStyle = '#ff4081';
  ctx.font = 'bold 52px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  var letter = (nameOrEmail||'U')[0].toUpperCase();
  ctx.fillText(letter, 55, 58);
  return canvas.toDataURL();
}

async function saveProfile(){
  var name = document.getElementById('nameInput').value.trim();
  var phone = document.getElementById('phoneInput').value.trim();

  var res = await _supabase.from("users").upsert({
    email: user.email,
    name: name,
    phone: phone
  }, {onConflict:'email'});

  if(res.error) showToast("âŒ Error: " + res.error.message);
  else showToast("âœ… Profile saved!");
}

// â”€â”€â”€ AVATAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function uploadAvatar(e){
  var file = e.target.files[0];
  if(!file) return;

  showToast("â³ Uploading...");

  var ext = file.name.split('.').pop();
  var fileName = user.email.replace(/[^a-z0-9]/gi,'_') + "-" + Date.now() + "." + ext;

  // Try bucket "avatars" first, then "avatar" (common naming variants)
  var bucketNames = ["avatars", "avatar", "images", "public"];
  var uploadSuccess = false;
  var url = '';

  for(var b=0; b<bucketNames.length; b++){
    var upRes = await _supabase.storage
      .from(bucketNames[b])
      .upload(fileName, file, {upsert:true});

    if(!upRes.error){
      var urlData = _supabase.storage.from(bucketNames[b]).getPublicUrl(fileName);
      url = urlData.data.publicUrl;
      uploadSuccess = true;
      break;
    }
  }

  if(!uploadSuccess){
    // Fallback: store avatar as base64 in users table directly
    var reader = new FileReader();
    reader.onload = async function(ev){
      var base64 = ev.target.result;
      document.getElementById('avatarImg').src = base64;
      await _supabase.from("users").upsert({
        email: user.email,
        avatar_url: base64
      }, {onConflict:'email'});
      showToast("âœ… Avatar saved locally!");
    };
    reader.readAsDataURL(file);
    return;
  }

  document.getElementById('avatarImg').src = url;

  await _supabase.from("users").upsert({
    email: user.email,
    avatar_url: url
  }, {onConflict:'email'});

  showToast("âœ… Avatar updated!");
}

// â”€â”€â”€ ADDRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveAddress(){
  var addr = document.getElementById('addressInput').value.trim();
  if(!addr){ showToast("Enter an address"); return; }

  async function doInsert(gps){
    var fullAddr = addr + (gps ? '  [GPS: '+gps+']' : '');
    await _supabase.from("addresses").insert({
      user_email: user.email,
      address: fullAddr
    });
    document.getElementById('addressInput').value = '';
    showToast("âœ… Address saved!");
    loadAddressesList();
    loadAddressesForCart();
  }

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      function(pos){ doInsert(pos.coords.latitude.toFixed(5)+","+pos.coords.longitude.toFixed(5)); },
      function(){ doInsert(''); },
      {timeout:5000}
    );
  } else {
    doInsert('');
  }
}

async function loadAddressesList(){
  var res = await _supabase.from("addresses").select("*").eq("user_email", user.email);
  var el = document.getElementById('addressList');
  var data = res.data || [];
  if(!data.length){
    el.innerHTML = '<div style="color:#555;font-size:13px;margin-top:8px;">No addresses saved yet</div>';
    return;
  }
  el.innerHTML = data.map(function(a){
    return '<div class="address-item">' +
      '<span>' + a.address + '</span>' +
      '<button class="delete-btn" onclick="deleteAddress(\'' + a.id + '\')">âœ•</button>' +
    '</div>';
  }).join('');
}

async function loadAddressesForCart(){
  var res = await _supabase.from("addresses").select("*").eq("user_email", user.email);
  var sel = document.getElementById('addressSelect');
  if(!sel) return;
  var data = res.data || [];
  sel.innerHTML = '<option value="">â€” Select delivery address â€”</option>' +
    data.map(function(a){ return '<option value="' + a.id + '">' + a.address + '</option>'; }).join('');
}

async function deleteAddress(id){
  await _supabase.from("addresses").delete().eq("id", id);
  showToast("ğŸ—‘ï¸ Address removed");
  loadAddressesList();
}

// â”€â”€â”€ ORDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOrders(){
  var el = document.getElementById('ordersList');
  el.innerHTML = '<div class="loading"><span class="spinner"></span>Loading orders...</div>';

  var res = await _supabase
    .from("orders")
    .select("*")
    .eq("user_email", user.email)
    .order("created_at", {ascending:false});

  var orders = res.data || [];

  if(!orders.length){
    el.innerHTML = '<div class="empty-state"><div>ğŸ“¦</div>No orders yet</div>';
    return;
  }

  el.innerHTML = '';
  for(var j=0; j<orders.length; j++){
    var order = orders[j];
    var iRes = await _supabase
      .from("order_items")
      .select("qty,price,products(name)")
      .eq("order_id", order.id);

    var items = iRes.data || [];
    var itemLines = items.map(function(i){
      return '<div class="order-item-line">' +
        (i.products ? i.products.name : 'Item') + ' Ã— ' + i.qty +
        ' â€” â‚¹' + (i.qty * i.price).toFixed(2) +
      '</div>';
    }).join('');

    el.innerHTML +=
      '<div class="order-card">' +
        '<div class="order-id">Order ID: ' + order.id + '</div>' +
        '<span class="status-badge">' + (order.status||'Placed') + '</span>' +
        '<div class="order-total">â‚¹' + parseFloat(order.price).toFixed(2) + '</div>' +
        itemLines +
      '</div>';
  }
}

// â”€â”€â”€ LOGOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogout(){
  localStorage.removeItem("user");
  location.href = "index.html";
}

// â”€â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
showHome();
</script>

</body>
</html>
