<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PetalRush Buyer</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
margin:0;
background:#0f1115;
color:white;
font-family:system-ui;
}

.container{
max-width:500px;
margin:auto;
min-height:100vh;
padding-bottom:70px;
}

.header{
background:#111;
padding:15px;
text-align:center;
}

.logo{
height:50px;
}

.filter-bar{
padding:10px;
background:#111;
display:flex;
gap:10px;
}

.search,input{
flex:1;
padding:10px;
border-radius:8px;
border:none;
background:#222;
color:white;
}

.products{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
gap:12px;
padding:12px;
}

.card{
background:#171a21;
padding:10px;
border-radius:12px;
cursor:pointer;
}

.card img{
width:100%;
height:130px;
object-fit:cover;
border-radius:8px;
}

.price{
color:#ff4081;
font-weight:bold;
}

.section{
display:none;
padding:12px;
}

.btn{
background:#ff4081;
border:none;
padding:12px;
width:100%;
border-radius:8px;
color:white;
margin-top:10px;
cursor:pointer;
}

.bottom{
position:fixed;
bottom:0;
width:100%;
max-width:500px;
display:flex;
background:#111;
}

.bottom div{
flex:1;
text-align:center;
padding:15px;
cursor:pointer;
}

.avatar{
width:100px;
height:100px;
border-radius:50%;
}

.cart-item{
background:#171a21;
padding:10px;
margin-top:10px;
border-radius:8px;
display:flex;
justify-content:space-between;
}
</style>
</head>

<body>

<div class="container">

<div class="header">
<img src="Headerlogo.png" class="logo">
</div>

<div id="filterSection" class="filter-bar">
<input id="search" placeholder="Search" oninput="searchProducts()">
</div>

<div id="home" class="products"></div>
<div id="detail" class="section"></div>
<div id="profile" class="section"></div>

<div id="cart" class="section">
<h2>Cart</h2>
<div id="cartItems"></div>
<h3 id="total">Total ₹0</h3>
<button class="btn" onclick="placeOrder()">Place Order</button>
</div>

<div class="bottom">
<div onclick="showHome()">Home</div>
<div onclick="showProfile()">Profile</div>
<div onclick="showCart()">Cart</div>
</div>

</div>

<script>

const supabaseClient = window.supabase.createClient(
"https://lssjsgfppehhclxqulso.supabase.co",
"YOUR_ANON_KEY"
);

let user = JSON.parse(localStorage.getItem("user"));

let currentProduct=null;
let currentQty=1;

function hideAll(){
home.style.display="none";
detail.style.display="none";
profile.style.display="none";
cart.style.display="none";
filterSection.style.display="none";
}

/* HOME */

async function showHome(){

hideAll();

home.style.display="grid";
filterSection.style.display="flex";

const {data}=await supabaseClient
.from("products")
.select("*");

home.innerHTML="";

data.forEach(p=>{

home.innerHTML+=`
<div class="card"
onclick="showDetail('${p.id}')">

<img src="${p.image_url}">
<div>${p.name}</div>
<div class="price">₹${p.price}</div>

</div>
`;

});
}

/* DETAIL */

async function showDetail(id){

hideAll();

detail.style.display="block";

const {data}=await supabaseClient
.from("products")
.select("*")
.eq("id",id)
.single();

currentProduct=data;
currentQty=1;

detail.innerHTML=`

<img src="${data.image_url}" width="100%">

<h2>${data.name}</h2>

<div class="price">
₹<span id="price">${data.price}</span>
</div>

Stock: ${data.quantity}

<br><br>

<button onclick="changeQty(-1)">-</button>
<span id="qty">1</span>
<button onclick="changeQty(1)">+</button>

<button class="btn" onclick="addCart()">Add to Cart</button>
<button class="btn" onclick="showHome()" style="background:#333">Back</button>

`;

}

function changeQty(val){

currentQty+=val;

if(currentQty<1) currentQty=1;
if(currentQty>currentProduct.quantity) currentQty=currentProduct.quantity;

qty.innerText=currentQty;
price.innerText=currentProduct.price*currentQty;

}

/* FIXED CART ADD */

async function addCart(){

const {data}=await supabaseClient
.from("cart")
.select("*")
.eq("user_email",user.email)
.eq("product_id",currentProduct.id)
.maybeSingle();

if(data){

await supabaseClient
.from("cart")
.update({
qty:data.qty+currentQty
})
.eq("id",data.id);

}else{

await supabaseClient
.from("cart")
.insert({
user_email:user.email,
product_id:currentProduct.id,
qty:currentQty
});

}

alert("Added to cart");

}

/* SHOW CART */

async function showCart(){

hideAll();

cart.style.display="block";

const {data,error}=await supabaseClient
.from("cart")
.select(`
id,
qty,
products (
name,
price
)
`)
.eq("user_email",user.email);

if(error){

alert(error.message);
return;

}

cartItems.innerHTML="";

let totalPrice=0;

data.forEach(item=>{

let price=item.products.price*item.qty;
totalPrice+=price;

cartItems.innerHTML+=`

<div class="cart-item">
<span>${item.products.name} x ${item.qty}</span>
<span>₹${price}</span>
</div>

`;

});

document.getElementById("total").innerText="Total ₹"+totalPrice;

}

/* PLACE ORDER */

async function placeOrder(){

const {data}=await supabaseClient
.from("cart")
.select(`
qty,
products(name,price)
`)
.eq("user_email",user.email);

for(const item of data){

await supabaseClient
.from("orders")
.insert({

user_email:user.email,
flower_name:item.products.name,
price:item.products.price*item.qty,
status:"Placed"

});

}

await supabaseClient
.from("cart")
.delete()
.eq("user_email",user.email);

alert("Order placed");

showHome();

}

/* SEARCH */

async function searchProducts(){

const {data}=await supabaseClient
.from("products")
.select("*")
.ilike("name","%"+search.value+"%");

home.innerHTML="";

data.forEach(p=>{

home.innerHTML+=`
<div class="card"
onclick="showDetail('${p.id}')">

<img src="${p.image_url}">
<div>${p.name}</div>
<div class="price">₹${p.price}</div>

</div>
`;

});

}

showHome();

</script>

</body>
</html>
