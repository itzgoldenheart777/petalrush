<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PetalRush Buyer</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
margin:0;
background:#0f1115;
color:white;
font-family:system-ui;
}

.container{
max-width:500px;
margin:auto;
min-height:100vh;
padding-bottom:70px;
}

.header{
background:#111;
padding:15px;
text-align:center;
}

.logo{ height:50px; }

.filter-bar{
padding:10px;
background:#111;
display:flex;
gap:10px;
position:sticky;
top:0;
}

.search{
flex:1;
padding:10px;
border-radius:8px;
border:none;
background:#222;
color:white;
}

select{
padding:10px;
background:#222;
color:white;
border:none;
border-radius:8px;
}

.products{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
gap:12px;
padding:12px;
}

.card{
background:#171a21;
padding:10px;
border-radius:12px;
cursor:pointer;
}

.card img{
width:100%;
height:130px;
object-fit:cover;
border-radius:8px;
}

.price{
color:#ff4081;
font-weight:bold;
}

.section{ display:none; padding:12px; }

.btn{
background:#ff4081;
border:none;
padding:12px;
width:100%;
border-radius:8px;
color:white;
margin-top:10px;
cursor:pointer;
}

.bottom{
position:fixed;
bottom:0;
width:100%;
max-width:500px;
display:flex;
background:#111;
}

.bottom div{
flex:1;
text-align:center;
padding:15px;
cursor:pointer;
}

.avatar{
width:100px;
height:100px;
border-radius:50%;
object-fit:cover;
}

.cart-item{
background:#171a21;
padding:10px;
margin-top:10px;
border-radius:8px;
display:flex;
justify-content:space-between;
}
</style>
</head>

<body>

<div class="container">

<div class="header">
<img src="Headerlogo.png" class="logo">
</div>

<div id="filterSection" class="filter-bar">
<input id="search" class="search" placeholder="Search" oninput="searchProducts()">
<select onchange="applyFilter(this.value)">
<option value="new">Newest</option>
<option value="low">Low → High</option>
<option value="high">High → Low</option>
</select>
</div>

<div id="home" class="products"></div>
<div id="detail" class="section"></div>

<div id="profile" class="section">
<h2>My Profile</h2>

<center>
<img id="avatar" class="avatar" src="default-avatar.png">
<br><br>
<input type="file" onchange="uploadAvatar(event)">
</center>

<div id="profileInfo"></div>

<h3>Delivery Address</h3>
<input id="addressInput" class="search" placeholder="Enter address">
<button class="btn" onclick="saveAddress()">Save Address</button>
<div id="addressList"></div>

<h3>My Orders</h3>
<div id="ordersList"></div>

<button class="btn" onclick="logout()" style="background:#333">Logout</button>
</div>

<div id="cart" class="section">
<h2>Cart</h2>
<div id="cartItems"></div>
<h3 id="total">Total ₹0</h3>
<button class="btn" onclick="placeOrder()">Place Order</button>
</div>

<div class="bottom">
<div onclick="showHome()">Home</div>
<div onclick="showProfile()">Profile</div>
<div onclick="showCart()">Cart</div>
</div>

</div>

<script>

const supabaseClient = supabase.createClient(
"https://lssjsgfppehhclxqulso.supabase.co",
"YOUR_ANON_KEY"
);

let user = JSON.parse(localStorage.getItem("user"));
if(!user){ alert("Login first"); location="index.html"; }

let currentProduct=null;

/* -------- UTIL -------- */

function hideAll(){
home.style.display="none";
detail.style.display="none";
profile.style.display="none";
cart.style.display="none";
filterSection.style.display="none";
}

/* -------- HOME -------- */

async function showHome(){
hideAll();
home.style.display="grid";
filterSection.style.display="flex";

const {data} = await supabaseClient.from("products").select("*");
renderProducts(data);
}

function renderProducts(data){
home.innerHTML="";
if(!data) return;

data.forEach(p=>{
home.innerHTML+=`
<div class="card" onclick="showDetail('${p.id}')">
<img src="${p.image_url}">
<div>${p.name}</div>
<div class="price">₹${p.price}</div>
</div>`;
});
}

/* SEARCH */
async function searchProducts(){
const text = search.value;
const {data} = await supabaseClient
.from("products")
.select("*")
.ilike("name","%"+text+"%");
renderProducts(data);
}

/* FILTER */
async function applyFilter(type){
let query = supabaseClient.from("products").select("*");
if(type=="low") query=query.order("price",{ascending:true});
if(type=="high") query=query.order("price",{ascending:false});
if(type=="new") query=query.order("created_at",{ascending:false});
const {data} = await query;
renderProducts(data);
}

/* -------- DETAIL -------- */

async function showDetail(id){
hideAll();
detail.style.display="block";

const {data} = await supabaseClient
.from("products")
.select("*")
.eq("id",id)
.single();

currentProduct=data;

detail.innerHTML=`
<img src="${data.image_url}" width="100%">
<h2>${data.name}</h2>
<div class="price">₹${data.price}</div>
Stock: ${data.quantity}
<button class="btn" onclick="addCart('${data.id}')">Add to Cart</button>
<button class="btn" onclick="showHome()" style="background:#333">Back</button>
`;
}

/* -------- ADD CART -------- */

async function addCart(productId){

const {data:existing} = await supabaseClient
.from("cart")
.select("*")
.eq("user_email",user.email)
.eq("product_id",productId);

if(existing.length>0){
await supabaseClient
.from("cart")
.update({qty: existing[0].qty + 1})
.eq("id", existing[0].id);
}else{
await supabaseClient
.from("cart")
.insert({
user_email:user.email,
product_id:productId,
qty:1
});
}

alert("Added to Cart");
}

/* -------- CART -------- */

async function showCart(){
hideAll();
cart.style.display="block";

const {data} = await supabaseClient
.from("cart")
.select("*,products(*)")
.eq("user_email",user.email);

cartItems.innerHTML="";
let totalAmount=0;

if(data.length===0){
cartItems.innerHTML="<p>Cart is empty</p>";
}

data.forEach(item=>{
let price=item.products.price*item.qty;
totalAmount+=price;

cartItems.innerHTML+=`
<div class="cart-item">
<span>${item.products.name} (x${item.qty})</span>
<span>₹${price}</span>
</div>`;
});

total.innerText="Total ₹"+totalAmount;
}

/* -------- PLACE ORDER -------- */

async function placeOrder(){

const {data} = await supabaseClient
.from("cart")
.select("*,products(*)")
.eq("user_email",user.email);

if(data.length===0){ alert("Cart empty"); return; }

for(const item of data){

await supabaseClient.from("orders").insert({
user_email:user.email,
flower_name:item.products.name,
price:item.products.price*item.qty,
status:"Placed"
});

}

/* Clear Cart */
await supabaseClient
.from("cart")
.delete()
.eq("user_email",user.email);

alert("Order Placed Successfully");

showProfile();
}

/* -------- PROFILE -------- */

async function showProfile(){
hideAll();
profile.style.display="block";

const {data} = await supabaseClient
.from("users")
.select("*")
.eq("email",user.email)
.single();

if(data?.avatar_url)
avatar.src=data.avatar_url;

profileInfo.innerHTML=`
<div style="background:#222;padding:10px;border-radius:8px;">
Name: <b>${data?.name||""}</b><br>
Phone: ${data?.phone||""}
</div>
`;

loadAddresses();
loadOrders();
}

/* ADDRESS */

async function saveAddress(){
await supabaseClient.from("addresses").insert({
user_email:user.email,
address:addressInput.value
});
addressInput.value="";
loadAddresses();
}

async function loadAddresses(){
const {data} = await supabaseClient
.from("addresses")
.select("*")
.eq("user_email",user.email);

addressList.innerHTML="";
data.forEach(a=>{
addressList.innerHTML+=`<div>${a.address}</div>`;
});
}

/* ORDERS */

async function loadOrders(){
const {data} = await supabaseClient
.from("orders")
.select("*")
.eq("user_email",user.email);

ordersList.innerHTML="";
data.forEach(o=>{
ordersList.innerHTML+=`
<div class="cart-item">
${o.flower_name}
<span>₹${o.price}</span>
</div>`;
});
}

/* AVATAR */

async function uploadAvatar(e){
const file=e.target.files[0];
const name=user.email+".png";

await supabaseClient.storage
.from("avatars")
.upload(name,file,{upsert:true});

const url="https://lssjsgfppehhclxqulso.supabase.co/storage/v1/object/public/avatars/"+name;

avatar.src=url;

await supabaseClient.from("users").upsert({
email:user.email,
avatar_url:url
});
}

/* LOGOUT */

function logout(){
localStorage.removeItem("user");
location="index.html";
}

/* INIT */

showHome();

</script>

</body>
</html>
