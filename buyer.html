<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PetalRush Buyer</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>

/* RESET */
*{box-sizing:border-box;margin:0;padding:0}

body{
font-family:system-ui,-apple-system,Segoe UI,Roboto;
background:#f4f6f8;
}

/* CONTAINER */
.container{
max-width:520px;
margin:auto;
background:#f4f6f8;
min-height:100vh;
position:relative;
display:flex;
flex-direction:column;
}

@media(min-width:700px){
.container{
margin-top:20px;
border-radius:16px;
box-shadow:0 0 30px rgba(0,0,0,0.15);
}
}

/* HEADER */
.header{
background:white;
padding:12px 16px;
box-shadow:0 2px 12px rgba(0,0,0,0.08);
position:sticky;
top:0;
z-index:100;
}

.logo{
height:36px;
}

.search{
margin-top:10px;
}

.search input{
width:100%;
padding:12px;
border-radius:10px;
border:1px solid #ddd;
font-size:15px;
}

/* PRODUCTS */
.products{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
gap:12px;
padding:12px;
padding-bottom:90px;
}

.card{
background:white;
border-radius:12px;
padding:10px;
box-shadow:0 2px 10px rgba(0,0,0,0.08);
}

.card img{
width:100%;
aspect-ratio:1/1;
object-fit:cover;
border-radius:10px;
}

.card h3{
font-size:15px;
margin-top:6px;
}

.price{
color:#ff4081;
font-weight:bold;
}

.btn{
background:#ff4081;
color:white;
border:none;
padding:10px;
width:100%;
border-radius:8px;
margin-top:6px;
cursor:pointer;
}

/* PROFILE */
.section{
display:none;
padding:14px;
padding-bottom:90px;
}

.profile-card{
background:white;
padding:15px;
border-radius:12px;
text-align:center;
box-shadow:0 2px 10px rgba(0,0,0,0.08);
}

.avatar{
width:90px;
height:90px;
border-radius:50%;
object-fit:cover;
margin-bottom:8px;
}

.input{
width:100%;
padding:12px;
margin-top:8px;
border-radius:8px;
border:1px solid #ddd;
}

.menu{
background:white;
margin-top:12px;
border-radius:12px;
overflow:hidden;
}

.menu-item{
padding:14px;
border-bottom:1px solid #eee;
cursor:pointer;
}

/* CART */
.bill{
background:white;
padding:14px;
border-radius:12px;
margin-top:10px;
}

/* NAV */
.bottom{
position:fixed;
bottom:0;
width:100%;
max-width:520px;
background:white;
display:flex;
justify-content:space-around;
padding:12px 0;
box-shadow:0 -3px 15px rgba(0,0,0,0.08);
}

.nav{
cursor:pointer;
font-size:14px;
}

.active{
color:#ff4081;
font-weight:bold;
}

</style>
</head>

<body>

<div class="container">

<!-- HEADER -->
<div class="header">
<img src="logoHeader.png" class="logo">
<div class="search">
<input id="searchInput" placeholder="Search flowers">
</div>
</div>

<!-- HOME -->
<div id="home" class="products"></div>

<!-- PROFILE -->
<div id="profile" class="section">

<div class="profile-card">

<img id="avatar" class="avatar" src="https://via.placeholder.com/90">

<input type="file" onchange="uploadAvatar(event)">

<h3 id="userEmail"></h3>

<input id="nameInput" class="input" placeholder="Enter name">

<button id="profileBtn" class="btn" onclick="saveProfile()">
Save Profile
</button>

</div>

<div class="menu">
<div class="menu-item" onclick="openAddress()">My Address</div>
<div class="menu-item" onclick="openHelp()">Help & Support</div>
<div class="menu-item" onclick="logout()">Logout</div>
</div>

</div>

<!-- ADDRESS -->
<div id="address" class="section">
<h3>Save Address</h3>
<input id="addressInput" class="input" placeholder="Enter address">
<button class="btn" onclick="getGPS()">Use GPS</button>
<button class="btn" onclick="saveAddress()">Save Address</button>
<div id="savedAddress" style="margin-top:10px;color:green"></div>
</div>

<!-- HELP -->
<div id="help" class="section">
<div class="bill">
<h3>Support</h3>
<p id="supportEmail"></p>
<p id="supportPhone"></p>
</div>
</div>

<!-- CART -->
<div id="cart" class="section">
<h3>Cart</h3>
<div id="cartItems"></div>
<div class="bill">
<p>Subtotal: ₹<span id="subTotal">0</span></p>
<p>GST (5%): ₹<span id="gst">0</span></p>
<p>Delivery: ₹<span id="delivery">30</span></p>
<hr>
<h3>Total: ₹<span id="total">0</span></h3>
</div>
</div>

<!-- NAV -->
<div class="bottom">
<div class="nav active" onclick="showHome()">Home</div>
<div class="nav" onclick="showProfile()">Profile</div>
<div class="nav" onclick="showCart()">Cart</div>
</div>

</div>

<script>

/* SUPABASE */
const SUPABASE_URL="https://lssjsgfppehhclxqulso.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxzc2pzZ2ZwcGVoaGNseHF1bHNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExOTAwNzksImV4cCI6MjA4Njc2NjA3OX0.nRq1iFBiOEyty0ALRmS45ARoso7BsB0ENOvttu7nvX0";
const client=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

/* USER */
const user=JSON.parse(localStorage.getItem("user"));
if(!user){location="index.html";}
document.getElementById("userEmail").innerText=user.email;

/* NAVIGATION */
function hideAll(){
home.style.display="none";
profile.style.display="none";
cart.style.display="none";
address.style.display="none";
help.style.display="none";
}

function showHome(){
hideAll();
home.style.display="grid";
}

function showProfile(){
hideAll();
profile.style.display="block";
loadProfile();
}

function showCart(){
hideAll();
cart.style.display="block";
updateBill();
}

function openAddress(){
hideAll();
address.style.display="block";
loadAddress();
}

function openHelp(){
hideAll();
help.style.display="block";
loadSupport();
}

/* PRODUCTS */
async function loadProducts(){
const {data}=await client.from("products").select("*");
const div=document.getElementById("home");
div.innerHTML="";
data.forEach(p=>{
div.innerHTML+=`
<div class="card">
<img src="${p.image_url}">
<h3>${p.name}</h3>
<div class="price">₹${p.price}</div>
<button class="btn" onclick='addToCart(${JSON.stringify(p)})'>Add</button>
</div>
`;
});
}
loadProducts();

/* SEARCH */
searchInput.addEventListener("input",async function(){
const val=this.value;
const {data}=await client.from("products")
.select("*")
.ilike("name",`%${val}%`);
home.innerHTML="";
data.forEach(p=>{
home.innerHTML+=`
<div class="card">
<img src="${p.image_url}">
<h3>${p.name}</h3>
<div class="price">₹${p.price}</div>
<button class="btn" onclick='addToCart(${JSON.stringify(p)})'>Add</button>
</div>`;
});
});

/* PROFILE */
async function loadProfile(){
const {data}=await client.from("users")
.select("*").eq("email",user.email).single();
if(data){
if(data.name) nameInput.value=data.name;
if(data.avatar_url) avatar.src=data.avatar_url;
profileBtn.innerText="Update Profile";
}
}

async function saveProfile(){
const name=nameInput.value;
const avatarUrl=avatar.src;
await client.from("users")
.upsert({email:user.email,name:name,avatar_url:avatarUrl});
alert("Profile Saved");
profileBtn.innerText="Update Profile";
}

async function uploadAvatar(e){
const file=e.target.files[0];
const fileName=user.email+".png";
await client.storage.from("avatars")
.upload(fileName,file,{upsert:true});
const url=SUPABASE_URL+
"/storage/v1/object/public/avatars/"+fileName+
"?t="+new Date().getTime();
avatar.src=url;
}

/* ADDRESS */
async function saveAddress(){
const addr=addressInput.value;
await client.from("users")
.update({address:addr})
.eq("email",user.email);
alert("Address saved");
loadAddress();
}

async function loadAddress(){
const {data}=await client.from("users")
.select("address")
.eq("email",user.email)
.single();
if(data && data.address){
savedAddress.innerText="Saved: "+data.address;
}
}

function getGPS(){
navigator.geolocation.getCurrentPosition(pos=>{
addressInput.value=
`https://maps.google.com/?q=${pos.coords.latitude},${pos.coords.longitude}`;
});
}

/* SUPPORT */
async function loadSupport(){
const {data}=await client.from("admin").select("*").single();
supportEmail.innerText="Email: "+data.email;
supportPhone.innerText="Phone: "+data.phone;
}

/* CART */
let cartData=[];

function addToCart(p){
cartData.push(p);
alert("Added to cart");
}

function updateBill(){
let sub=0;
cartItems.innerHTML="";
cartData.forEach(p=>{
sub+=Number(p.price);
cartItems.innerHTML+=`
<p>${p.name} - ₹${p.price}</p>
`;
});
let gst=sub*0.05;
let delivery=30;
let total=sub+gst+delivery;
subTotal.innerText=sub.toFixed(2);
gst.innerText=gst.toFixed(2);
total.innerText=total.toFixed(2);
}

/* LOGOUT */
function logout(){
localStorage.removeItem("user");
location="index.html";
}

showHome();

</script>

</body>
</html>
