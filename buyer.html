<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>PetalRush Buyer</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>

/* GLOBAL */

body{
margin:0;
background:#0f1115;
color:white;
font-family:system-ui;
}

.container{
max-width:500px;
margin:auto;
min-height:100vh;
padding-bottom:80px;
}

/* HEADER */

.header{
background:#111;
padding:15px;
text-align:center;
}

.logo{
height:50px;
}

/* FILTER */

.filter-bar{
padding:10px;
background:#111;
display:flex;
gap:10px;
position:sticky;
top:0;
}

input,select{
flex:1;
padding:10px;
border-radius:8px;
border:none;
background:#222;
color:white;
}

/* PRODUCTS */

.products{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
gap:10px;
padding:10px;
}

.card{
background:#171a21;
padding:10px;
border-radius:10px;
cursor:pointer;
}

.card img{
width:100%;
height:130px;
object-fit:cover;
border-radius:8px;
}

.price{
color:#ff4081;
}

/* SECTION */

.section{
display:none;
padding:10px;
}

/* BUTTON */

.btn{
background:#ff4081;
border:none;
padding:12px;
width:100%;
border-radius:8px;
color:white;
margin-top:10px;
}

/* CART */

.cart-item{
background:#171a21;
padding:10px;
margin-top:10px;
border-radius:8px;
display:flex;
justify-content:space-between;
}

/* NAV */

.bottom{
position:fixed;
bottom:0;
width:100%;
max-width:500px;
display:flex;
background:#111;
}

.bottom div{
flex:1;
text-align:center;
padding:15px;
cursor:pointer;
}

</style>

</head>

<body>

<div class="container">

<div class="header">
<img src="Headerlogo.png" class="logo">
</div>

<div id="filterSection" class="filter-bar">

<input id="search" placeholder="Search"
oninput="searchProducts()">

<select onchange="applyFilter(this.value)">
<option value="new">Newest</option>
<option value="low">Low Price</option>
<option value="high">High Price</option>
</select>

</div>

<div id="home" class="products"></div>

<div id="detail" class="section"></div>

<div id="profile" class="section">

<h2>Profile</h2>

<input id="nameInput" placeholder="Name">
<input id="phoneInput" placeholder="Phone">

<button class="btn"
onclick="saveProfile()">Save</button>

<h3>Addresses</h3>

<input id="addressInput" placeholder="Address">

<button class="btn"
onclick="saveAddress()">Save Address</button>

<div id="addressList"></div>

<h3>Orders</h3>

<div id="ordersList"></div>

<button class="btn"
onclick="logout()">Logout</button>

</div>

<div id="cart" class="section">

<h2>Cart</h2>

<div id="cartItems"></div>

<div>

Subtotal ₹<span id="subtotal">0</span><br>
Delivery ₹<span id="delivery">0</span><br>
GST ₹<span id="gst">0</span><br>
Discount ₹<span id="discount">0</span><br>

Total ₹<span id="grandTotal">0</span>

</div>

<select id="addressSelect"></select>

<input id="couponInput" placeholder="Coupon">

<button class="btn"
onclick="applyCoupon()">Apply Coupon</button>

<button class="btn"
onclick="placeOrder()">Place Order</button>

</div>

<div class="bottom">

<div onclick="showHome()">Home</div>
<div onclick="showCart()">Cart</div>
<div onclick="showProfile()">Profile</div>

</div>

</div>



<script>

const supabaseClient = window.supabase.createClient(
"https://lssjsgfppehhclxqulso.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxzc2pzZ2ZwcGVoaGNseHF1bHNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExOTAwNzksImV4cCI6MjA4Njc2NjA3OX0.nRq1iFBiOEyty0ALRmS45ARoso7BsB0ENOvttu7nvX0"
);

let user = JSON.parse(localStorage.getItem("user"));
if(!user){ location="index.html"; }

let currentProduct=null;
let currentQty=1;
let cartData=[];
let discountAmount=0;

/* ================= NAV ================= */

function hideAll(){
home.style.display="none";
detail.style.display="none";
profile.style.display="none";
cart.style.display="none";
filterSection.style.display="none";
}

/* ================= HOME ================= */

async function showHome(){
hideAll();
home.style.display="grid";
filterSection.style.display="flex";

const {data} = await supabaseClient
.from("products")
.select("*");

renderProducts(data);
}

function renderProducts(data){
home.innerHTML="";
data.forEach(p=>{
home.innerHTML+=`
<div class="card" onclick="showDetail('${p.id}')">
<img src="${p.image_url}">
<div>${p.name}</div>
<div class="price">₹${p.price}</div>
</div>`;
});
}

/* ================= DETAIL ================= */

async function showDetail(id){
hideAll();
detail.style.display="block";

const {data} = await supabaseClient
.from("products")
.select("*")
.eq("id",id)
.single();

currentProduct=data;
currentQty=1;

detail.innerHTML=`
<img src="${data.image_url}" width="100%">
<h2>${data.name}</h2>
₹<span id="price">${data.price}</span><br>
Stock: ${data.quantity}<br><br>
<button onclick="changeQty(-1)">-</button>
<span id="qty">1</span>
<button onclick="changeQty(1)">+</button>
<button class="btn" onclick="addCart()">Add Cart</button>
<button class="btn" onclick="showHome()">Back</button>
`;
}

function changeQty(v){
currentQty+=v;
if(currentQty<1) currentQty=1;
qty.innerText=currentQty;
price.innerText=currentProduct.price*currentQty;
}

/* ================= CART ================= */

async function addCart(){

const {data:exist} =
await supabaseClient.from("cart")
.select("*")
.eq("user_email",user.email)
.eq("product_id",currentProduct.id)
.maybeSingle();

if(exist){
await supabaseClient.from("cart")
.update({qty:exist.qty+currentQty})
.eq("id",exist.id);
}else{
await supabaseClient.from("cart")
.insert({
user_email:user.email,
product_id:currentProduct.id,
qty:currentQty
});
}

alert("Added to cart");
showCart();
}

async function showCart(){

hideAll();
cart.style.display="block";

const {data} = await supabaseClient
.from("cart")
.select(`
id,
qty,
products(id,name,price)
`)
.eq("user_email",user.email);

cartData=data;
let subtotal=0;

cartItems.innerHTML="";

data.forEach(i=>{
let price=i.products.price*i.qty;
subtotal+=price;

cartItems.innerHTML+=`
<div class="cart-item">
${i.products.name} x ${i.qty}
<button onclick="removeCart('${i.id}')">X</button>
</div>`;
});

calculateTotals(subtotal);
loadAddresses();
loadAvailableCoupons();
}

function calculateTotals(sub){

let del = sub===0 ? 0 : (sub<500?50:0);
let gst = sub*0.05;
let total = sub+del+gst-discountAmount;

subtotal.innerText=sub;
delivery.innerText=del;
gst.innerText=gst;
discount.innerText=discountAmount;
grandTotal.innerText=total;
}

async function removeCart(id){
await supabaseClient.from("cart").delete().eq("id",id);
showCart();
}

/* ================= COUPON ================= */

async function loadAvailableCoupons(){

const {data} = await supabaseClient
.from("coupons")
.select("*");

let available = data.filter(c=> 
!c.usage_limit || c.used_count < c.usage_limit
);

if(available.length>0){
couponInput.placeholder = "Available: " + 
available.map(c=>c.code).join(", ");
}
}

async function applyCoupon(){

const code = couponInput.value.trim();

const {data} = await supabaseClient
.from("coupons")
.select("*")
.eq("code",code)
.maybeSingle();

if(!data){
alert("Invalid coupon");
return;
}

if(data.usage_limit && data.used_count >= data.usage_limit){
alert("Coupon limit reached");
return;
}

discountAmount=data.discount;

await supabaseClient
.from("coupons")
.update({used_count:data.used_count+1})
.eq("code",code);

alert("Coupon applied");
showCart();
}

/* ================= ORDER ================= */

async function placeOrder(){

if(cartData.length===0){
alert("Cart empty");
return;
}

let orderId="ORD-"+Date.now();

for(const item of cartData){

await supabaseClient.from("order_items").insert({
order_id:orderId,
product_id:item.products.id,
qty:item.qty,
price:item.products.price
});
}

await supabaseClient.from("orders").insert({
id:orderId,
user_email:user.email,
price:grandTotal.innerText,
status:"Placed"
});

await supabaseClient.from("cart")
.delete().eq("user_email",user.email);

alert("Order placed\nOrder ID: "+orderId);

discountAmount=0;
showProfile();
}

/* ================= PROFILE ================= */

async function showProfile(){
hideAll();
profile.style.display="block";

loadOrders();
loadAddresses();
}

async function loadOrders(){

const {data} = await supabaseClient
.from("orders")
.select("*")
.eq("user_email",user.email);

ordersList.innerHTML="";

for(const o of data){

const {data:items} =
await supabaseClient
.from("order_items")
.select("*")
.eq("order_id",o.id);

ordersList.innerHTML+=`
<div class="cart-item">
<b>${o.id}</b><br>
₹${o.price}<br>
${items.map(i=>"Qty:"+i.qty+" ₹"+i.price).join("<br>")}
</div>`;
}
}

/* ================= ADDRESS ================= */

async function saveAddress(){

navigator.geolocation.getCurrentPosition(async pos=>{

let gps=pos.coords.latitude+","+pos.coords.longitude;

await supabaseClient.from("addresses").insert({
user_email:user.email,
address:addressInput.value+" GPS:"+gps
});

loadAddresses();
});
}

async function loadAddresses(){

const {data} = await supabaseClient
.from("addresses")
.select("*")
.eq("user_email",user.email);

addressSelect.innerHTML="";
addressList.innerHTML="";

data.forEach(a=>{
addressSelect.innerHTML+=`<option>${a.address}</option>`;
addressList.innerHTML+=`<div>${a.address}</div>`;
});
}

/* ================= START ================= */

showHome();

</script>

</body>
</html>
